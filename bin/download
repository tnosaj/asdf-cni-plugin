#!/usr/bin/env bash
set -euo pipefail

: "${ASDF_INSTALL_VERSION:?ASDF_INSTALL_VERSION is required}"
: "${ASDF_DOWNLOAD_PATH:?ASDF_DOWNLOAD_PATH is required}"

VERSION="${ASDF_INSTALL_VERSION}"

# Detect OS
case "$(uname -s)" in
  Linux) OS="linux" ;;
  Darwin)
    # CNI plugins are really meant for Linux; you can either fail
    # or map to linux here. I'll fail to be explicit.
    echo "CNI plugins are only published for Linux; current OS is Darwin." >&2
    exit 1
    ;;
  *)
    echo "Unsupported OS: $(uname -s)" >&2
    exit 1
    ;;
esac

# Detect arch
case "$(uname -m)" in
  x86_64|amd64) ARCH="amd64" ;;
  aarch64|arm64) ARCH="arm64" ;;
  *)
    echo "Unsupported architecture: $(uname -m)" >&2
    exit 1
    ;;
esac

TARBALL="cni-plugins-${OS}-${ARCH}-v${VERSION}.tgz"
BASE_URL="https://github.com/containernetworking/plugins/releases/download"
URL="${BASE_URL}/v${VERSION}/${TARBALL}"

mkdir -p "${ASDF_DOWNLOAD_PATH}"
cd "${ASDF_DOWNLOAD_PATH}"

echo "Downloading ${URL} ..."
curl -fL -o "${TARBALL}" "${URL}"

echo "Extracting ${TARBALL} into ${ASDF_DOWNLOAD_PATH} ..."
tar xzf "${TARBALL}"
rm -f "${TARBALL}"

